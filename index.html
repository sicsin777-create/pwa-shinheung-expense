<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b3d91" />

  <title>신흥중 야구부 가계부</title>

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sanitize.css" />

  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      margin: 0;
      background: #f1f5f9;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, #0b3d91, #1976d2);
      padding: 32px 20px;
      color: white;
      border-bottom-left-radius: 32px;
      border-bottom-right-radius: 32px;
    }

    .title {
      font-size: 32px;
      font-weight: 800;
    }

    .subtitle {
      font-size: 16px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .month-select {
      margin-top: 20px;
      background: rgba(255,255,255,0.18);
      padding: 10px 16px;
      display: inline-block;
      border-radius: 14px;
      font-size: 18px;
      backdrop-filter: blur(3px);
    }

    .cards {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      padding: 0 20px;
    }

    .card {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 16px;
      opacity: 0.7;
    }

    .card-value {
      font-size: 32px;
      font-weight: 700;
      margin-top: 10px;
      color: #0b3d91;
    }

    .list-title {
      font-size: 22px;
      font-weight: 700;
      margin: 32px 20px 16px;
    }

    /* Floating button */
    .fab {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #0b3d91;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.25);
    }

    /* Modal */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background: white;
      width: 90%;
      max-width: 420px;
      padding: 24px;
      border-radius: 20px;
    }

    .input-box {
      margin-top: 16px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    textarea { height: 90px; }

    .btn {
      width: 100%;
      margin-top: 20px;
      background: #0b3d91;
      color: white;
      padding: 14px;
      border-radius: 14px;
      text-align: center;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<!-- ================= HEADER ================== -->
<div class="header">
  <div class="title">신흥중 야구부</div>
  <div class="subtitle">집행부 전용 가계부</div>

  <div class="month-select">
    <select id="selectMonth">
      <option>2025 / 11</option>
      <option>2025 / 12</option>
      <option>2026 / 01</option>
    </select>
  </div>
</div>

<!-- ================= DASHBOARD ================= -->
<div class="cards">
  <div class="card">
    <div class="card-title">이번달 예산</div>
    <div class="card-value" id="budget">₩0</div>
  </div>

  <div class="card">
    <div class="card-title">지출 합계</div>
    <div class="card-value" id="total">₩0</div>
  </div>

  <div class="card">
    <div class="card-title">남은 예산</div>
    <div class="card-value" id="left">₩0</div>
  </div>
</div>

<div class="list-title">지출 내역</div>
<div id="expenseList"></div>

<!-- Floating Button -->
<div class="fab" onclick="openModal()">+</div>

<!-- ================ Modal ================ -->
<div class="modal-bg" id="modalBG">
  <div class="modal">
    <h2>지출 등록</h2>

    <div class="input-box">
      <label>등록자</label>
      <input id="writer" placeholder="예: 홍길동" />
    </div>

    <div class="input-box">
      <label>지출일</label>
      <input id="date" type="date" />
    </div>

    <div class="input-box">
      <label>카테고리</label>
      <select id="category">
        <option>식비</option>
        <option>용품</option>
        <option>훈련비</option>
        <option>기타</option>
      </select>
    </div>

    <div class="input-box">
      <label>금액</label>
      <input id="amount" type="number" />
    </div>

    <div class="input-box">
      <label>내용</label>
      <textarea id="content"></textarea>
    </div>

    <div class="input-box">
      <label>영수증 이미지</label>
      <input id="receiptFile" type="file" accept="image/*" />
    </div>

    <div class="btn" onclick="saveExpense()">저장</div>
  </div>
</div>

<script>
/* ========================================
   GitHub API 설정
======================================== */
const GITHUB_TOKEN = "YOUR_TOKEN_HERE";  // ← 너의 토큰 입력
const REPO_OWNER = "sicsin777-create";
const REPO_NAME = "pwa-shinheung-expense";


/* ========================================
   Modal 기능
======================================== */
function openModal() {
  document.getElementById("modalBG").style.display = "flex";
}

function closeModal() {
  document.getElementById("modalBG").style.display = "none";
}


/* ========================================
   Base64 변환
======================================== */
function fileToBase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(file);
  });
}


/* ========================================
   GitHub에 파일 업로드 함수
======================================== */
async function uploadToGitHub(path, contentBase64) {
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`;

  const res = await fetch(url, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${GITHUB_TOKEN}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update data",
      content: contentBase64
    })
  });

  return await res.json();
}


/* ========================================
   expenses.json 불러오기
======================================== */
async function loadExpenses() {
  const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/data/expenses.json`;
  const res = await fetch(url);
  return await res.json();
}


/* ========================================
   지출 저장 기능
======================================== */
async function saveExpense() {
  const writer = document.getElementById("writer").value;
  const date = document.getElementById("date").value;
  const category = document.getElementById("category").value;
  const amount = Number(document.getElementById("amount").value);
  const content = document.getElementById("content").value;
  const file = document.getElementById("receiptFile").files[0];

  if (!writer || !date || !amount) {
    alert("필수항목을 입력하세요.");
    return;
  }

  let receiptURL = "";

  // ============ 이미지 업로드 ===============
  if (file) {
    const base64 = await fileToBase64(file);
    const fileName = `data/receipts/${Date.now()}.png`;

    const uploadResult = await uploadToGitHub(fileName, base64);
    receiptURL = uploadResult.content.download_url;
  }

  // ============ 기존 데이터 로드 ===============
  const expenses = await loadExpenses();

  const newItem = {
    id: Date.now(),
    writer,
    date,
    category,
    amount,
    content,
    receipt: receiptURL
  };

  expenses.push(newItem);

  // ============ JSON 다시 업로드 ===============
  const jsonBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(expenses, null, 2))));
  await uploadToGitHub("data/expenses.json", jsonBase64);

  alert("저장되었습니다!");
  closeModal();
  location.reload();
}
</script>

</body>
</html>
